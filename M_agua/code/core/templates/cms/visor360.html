{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        #panorama {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        .contenido {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100vh;
            pointer-events: none;
        }
        
        .contenido * {
            pointer-events: auto;
        }
        
        .menu-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 90vw;
        }
        
        .escenas-menu {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            max-width: 100%;
        }
        
        .escenas-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .escena-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .escena-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .escena-btn.active {
            border-color: #ffd700;
            border-width: 4px;
        }
        
        .escena-btn::after {
            content: attr(data-titulo);
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        
        .escena-btn:hover::after {
            opacity: 1;
        }
        
        .categorias-menu {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .categoria-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .categoria-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .categoria-btn.active {
            border-color: #ffd700;
            border-width: 5px;
            transform: scale(1.05);
        }
        
        .categoria-btn::after {
            content: attr(data-titulo);
            position: absolute;
            top: 100%;
            margin-top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        
        .categoria-btn:hover::after {
            opacity: 1;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            color: white;
            font-size: 1.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.5);
            padding: 20px 40px;
            border-radius: 10px;
        }
        
        .no-escenas {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem;
        }
        
        .no-escenas h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .no-escenas p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin-bottom: 0.5rem;
        }
        
        .no-escenas a {
            display: inline-block;
            margin-top: 2rem;
            padding: 1rem 2rem;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .no-escenas a:hover {
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .escena-btn {
                width: 60px;
                height: 60px;
            }
            
            .categoria-btn {
                width: 70px;
                height: 70px;
            }
            
            .escenas-menu, .categorias-menu {
                gap: 10px;
            }
            
            .menu-container {
                bottom: 20px;
            }
            
            .categoria-btn::after,
            .escena-btn::after {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    {% if imagen_inicial %}
    <div id="panorama"></div>
    
    <div class="loading" id="loading" style="display: none;">Cargando...</div>
    
    <div class="contenido">
        <div class="menu-container">
            <div class="escenas-menu" id="escenasMenu"></div>
            
            <div class="categorias-menu">
                {% for categoria in categorias %}
                <div class="categoria-btn {% if forloop.first %}active{% endif %}"
                     data-categoria-id="{{ categoria.id }}"
                     data-titulo="{{ categoria.titulo }}"
                     data-fondo="{% if categoria.imagen_fondo %}{{ categoria.imagen_fondo.url }}{% endif %}"
                     style="background-image: url('{{ categoria.icono.url }}'); background-color: {{ categoria.color_fondo }};">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <script id="escenas-data" type="application/json">
        {
            {% for categoria in categorias %}
            "{{ categoria.id }}": [
                {% for escena in categoria.escenas.all %}
                {% if escena.activa %}
                {
                    "id": {{ escena.id }},
                    "titulo": "{{ escena.titulo|escapejs }}",
                    "imagen": "{{ escena.imagen.url }}",
                    "icono": "{{ escena.icono.url }}"
                }{% if not forloop.last %},{% endif %}
                {% endif %}
                {% endfor %}
            ]{% if not forloop.last %},{% endif %}
            {% endfor %}
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script>
        let viewer;
        let currentSceneId = {{ escena_inicial.id|default:"null" }};
        let currentCategoriaId = {{ escena_inicial.categoria.id }};
        const escenasData = JSON.parse(document.getElementById('escenas-data').textContent);
        
        function initViewer(imageUrl) {
            if (!imageUrl) return;
            
            document.getElementById('loading').style.display = 'block';
            
            if (viewer) {
                viewer.destroy();
            }
            
            viewer = pannellum.viewer('panorama', {
                "type": "equirectangular",
                "panorama": imageUrl,
                "autoLoad": true,
                "autoRotate": -2,
                "showControls": false,
                "mouseZoom": true,
                "draggable": true,
                "compass": false,
                "friction": 0.15,
                "onLoad": function() {
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }
        
        initViewer("{{ imagen_inicial }}");
        
        const escenasMenu = document.getElementById('escenasMenu');
        const categoriaBtns = document.querySelectorAll('.categoria-btn');
        
        function mostrarEscenas(categoriaId) {
            const escenas = escenasData[categoriaId] || [];
            escenasMenu.innerHTML = '';
            
            escenas.forEach((escena) => {
                const btn = document.createElement('div');
                btn.className = 'escena-btn';
                if (escena.id === currentSceneId) {
                    btn.classList.add('active');
                }
                btn.setAttribute('data-imagen', escena.imagen);
                btn.setAttribute('data-titulo', escena.titulo);
                btn.setAttribute('data-id', escena.id);
                btn.style.backgroundImage = `url('${escena.icono}')`;
                
                btn.addEventListener('click', function() {
                    const imagenUrl = this.getAttribute('data-imagen');
                    const escenaId = parseInt(this.getAttribute('data-id'));
                    
                    if (escenaId !== currentSceneId) {
                        document.querySelectorAll('.escena-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        currentSceneId = escenaId;
                        initViewer(imagenUrl);
                    }
                });
                
                escenasMenu.appendChild(btn);
            });
            
            escenasMenu.classList.add('active');
        }
        
        categoriaBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const categoriaId = parseInt(this.getAttribute('data-categoria-id'));
                const fondoUrl = this.getAttribute('data-fondo');
                
                if (categoriaId !== currentCategoriaId) {
                    categoriaBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentCategoriaId = categoriaId;
                    
                    // Si la categoría tiene fondo propio, usarlo
                    if (fondoUrl) {
                        initViewer(fondoUrl);
                    } else {
                        // Si no, usar la primera escena
                        const escenas = escenasData[categoriaId] || [];
                        if (escenas.length > 0) {
                            initViewer(escenas[0].imagen);
                        }
                    }
                    
                    mostrarEscenas(categoriaId);
                    currentSceneId = null;
                    document.querySelectorAll('.escena-btn').forEach(b => b.classList.remove('active'));
                } else {
                    if (escenasMenu.classList.contains('active')) {
                        escenasMenu.classList.remove('active');
                    } else {
                        mostrarEscenas(categoriaId);
                    }
                }
            });
        });
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-container')) {
                escenasMenu.classList.remove('active');
            }
        });
    </script>
    {% else %}
    <div class="no-escenas">
        <h1>Visor 360</h1>
        <p>No hay categorías ni escenas 360 disponibles.</p>
        <p>Por favor, agrega categorías y escenas desde el panel de administración.</p>
        <a href="/admin/cms/categoriaescena/">Ir al Panel de Administración</a>
    </div>
    {% endif %}
</body>
</html>