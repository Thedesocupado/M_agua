{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <link rel="stylesheet" href="{% static 'css/visor360.css' %}">
    <style>
        .logos-container {
            {% if config.mostrar_fondo_logos %}
            background: {{ config.get_rgba_logos }};
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            {% endif %}
        }
        
        .titulos-container {
            {% if config.mostrar_fondo_titulos %}
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            {% endif %}
        }
        
        .titulo-principal {
            font-size: {{ config.tamano_titulo_principal }}px;
        }
        
        .titulo-actual {
            font-size: {{ config.tamano_titulo_secundario }}px;
        }
        
        .descripcion-container {
            {% if config.usar_imagen_descripcion and config.imagen_fondo_descripcion %}
            background-image: url('{{ config.imagen_fondo_descripcion.url }}');
            background-size: cover;
            background-position: center;
            {% else %}
            background: {{ config.get_rgba_descripcion }};
            {% endif %}
        }
        
        .descripcion-titulo {
            font-family: {{ config.fuente_titulo_descripcion }};
            font-size: {{ config.tamano_titulo_descripcion }}px;
        }
        
        .descripcion-texto {
            font-family: {{ config.fuente_texto_descripcion }};
            font-size: {{ config.tamano_texto_descripcion }}px;
        }
        
        @media (max-width: 768px) {
            .titulo-principal {
                font-size: {{ config.tamano_titulo_principal|add:"-8" }}px;
            }
            
            .titulo-actual {
                font-size: {{ config.tamano_titulo_secundario|add:"-6" }}px;
            }
            
            .descripcion-titulo {
                font-size: {{ config.tamano_titulo_descripcion|add:"-4" }}px;
            }
            
            .descripcion-texto {
                font-size: {{ config.tamano_texto_descripcion|add:"-2" }}px;
            }
        }
    </style>
</head>
<body>
    {% if imagen_inicial %}
    <div id="panorama"></div>
    
    <div class="contenido">
        <div class="header-container">
            {% if logos %}
            <div class="logos-container">
                {% for logo in logos %}
                <div class="logo-item">
                    {% if logo.url %}
                    <a href="{{ logo.url }}" target="_blank" rel="noopener noreferrer">
                        <img src="{{ logo.logo.url }}" alt="{{ logo.nombre }}">
                    </a>
                    {% else %}
                    <img src="{{ logo.logo.url }}" alt="{{ logo.nombre }}">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="titulos-container">
                <div class="titulo-principal">{{ config.titulo_principal }}</div>
                <div class="titulo-actual" id="tituloActual">{{ escena_inicial.titulo }}</div>
            </div>
        </div>
        
        <div class="descripcion-container" id="descripcionContainer">
            <h2 class="descripcion-titulo" id="descripcionTitulo">{{ escena_inicial.titulo }}</h2>
            <p class="descripcion-texto" id="descripcionTexto">{{ escena_inicial.descripcion|default:"" }}</p>
        </div>
        
        <div class="menu-container">
            <div class="escenas-menu" id="escenasMenu"></div>
            
            <div class="categorias-menu">
                {% for categoria in categorias %}
                <div class="categoria-btn {% if forloop.first %}active{% endif %}"
                     data-categoria-id="{{ categoria.id }}"
                     data-titulo="{{ categoria.titulo }}"
                     data-fondo="{% if categoria.imagen_fondo %}{{ categoria.imagen_fondo.url }}{% endif %}"
                     style="background-image: url('{{ categoria.icono.url }}'); background-color: {{ categoria.color_fondo }};">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="video-modal" id="videoModal">
        <div class="video-modal-content">
            <div class="video-modal-header">
                <button class="video-modal-open-youtube" id="openYoutubeBtn">
                    ▶ Abrir en YouTube
                </button>
                <button class="video-modal-close" id="closeVideoModal">×</button>
            </div>
            <iframe id="videoIframe" 
                    src="/placeholder.svg" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    allowfullscreen
                    referrerpolicy="strict-origin-when-cross-origin"></iframe>
        </div>
    </div>
    
    <script id="escenas-data" type="application/json">
        {
            {% for categoria in categorias %}
            "{{ categoria.id }}": [
                {% for escena in categoria.escenas.all %}
                {% if escena.activa %}
                {
                    "id": {{ escena.id }},
                    "titulo": "{{ escena.titulo|escapejs }}",
                    "descripcion": "{{ escena.descripcion|escapejs }}",
                    "imagen": "{{ escena.imagen.url }}",
                    "icono": "{{ escena.icono.url }}",
                    "video": "{{ escena.get_youtube_embed_url|default:'' }}",
                    "videoUrl": "{{ escena.get_youtube_watch_url|default:'' }}"
                }{% if not forloop.last %},{% endif %}
                {% endif %}
                {% endfor %}
            ]{% if not forloop.last %},{% endif %}
            {% endfor %}
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script>
        let viewer;
        let currentSceneId = {{ escena_inicial.id|default:"null" }};
        let currentCategoriaId = {{ escena_inicial.categoria.id }};
        const escenasData = JSON.parse(document.getElementById('escenas-data').textContent);
        
        const descripcionContainer = document.getElementById('descripcionContainer');
        const descripcionTitulo = document.getElementById('descripcionTitulo');
        const descripcionTexto = document.getElementById('descripcionTexto');
        const tituloActual = document.getElementById('tituloActual');
        const videoModal = document.getElementById('videoModal');
        const videoIframe = document.getElementById('videoIframe');
        const closeVideoModal = document.getElementById('closeVideoModal');
        const openYoutubeBtn = document.getElementById('openYoutubeBtn');
        
        let currentVideoUrl = '';
        
        setTimeout(() => {
            descripcionContainer.classList.add('visible');
        }, 500);
        
        function actualizarDescripcion(titulo, descripcion) {
            descripcionTitulo.textContent = titulo;
            descripcionTexto.textContent = descripcion || '';
            tituloActual.textContent = titulo;
            
            if (!descripcion) {
                descripcionContainer.classList.remove('visible');
            } else {
                descripcionContainer.classList.add('visible');
            }
        }
        
        function abrirVideo(videoEmbedUrl, videoWatchUrl) {
            if (videoEmbedUrl) {
                currentVideoUrl = videoWatchUrl;
                videoIframe.src = videoEmbedUrl + '?autoplay=1';
                videoModal.classList.add('active');
            }
        }
        
        function cerrarVideo() {
            videoModal.classList.remove('active');
            videoIframe.src = '';
            currentVideoUrl = '';
        }
        
        function abrirEnYouTube() {
            if (currentVideoUrl) {
                window.open(currentVideoUrl, '_blank');
            }
        }
        
        closeVideoModal.addEventListener('click', cerrarVideo);
        openYoutubeBtn.addEventListener('click', abrirEnYouTube);
        
        videoModal.addEventListener('click', function(e) {
            if (e.target === videoModal) {
                cerrarVideo();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarVideo();
            }
        });
        
        function initViewer(imageUrl) {
            if (!imageUrl) return;
            
            if (viewer) {
                viewer.destroy();
            }
            
            viewer = pannellum.viewer('panorama', {
                "type": "equirectangular",
                "panorama": imageUrl,
                "autoLoad": true,
                "autoRotate": -2,
                "showControls": false,
                "mouseZoom": true,
                "draggable": true,
                "compass": false,
                "friction": 0.15
            });
        }
        
        initViewer("{{ imagen_inicial }}");
        
        const escenasMenu = document.getElementById('escenasMenu');
        const categoriaBtns = document.querySelectorAll('.categoria-btn');
        
        function mostrarEscenas(categoriaId) {
            const escenas = escenasData[categoriaId] || [];
            escenasMenu.innerHTML = '';
            
            escenas.forEach((escena) => {
                const btn = document.createElement('div');
                btn.className = 'escena-btn';
                if (escena.id === currentSceneId) {
                    btn.classList.add('active');
                }
                if (escena.video) {
                    btn.classList.add('has-video');
                }
                btn.setAttribute('data-imagen', escena.imagen);
                btn.setAttribute('data-titulo', escena.titulo);
                btn.setAttribute('data-descripcion', escena.descripcion);
                btn.setAttribute('data-id', escena.id);
                btn.setAttribute('data-video', escena.video);
                btn.setAttribute('data-video-url', escena.videoUrl);
                btn.style.backgroundImage = `url('${escena.icono}')`;
                
                btn.addEventListener('click', function() {
                    const videoEmbedUrl = this.getAttribute('data-video');
                    const videoWatchUrl = this.getAttribute('data-video-url');
                    
                    if (videoEmbedUrl) {
                        abrirVideo(videoEmbedUrl, videoWatchUrl);
                    } else {
                        const imagenUrl = this.getAttribute('data-imagen');
                        const escenaId = parseInt(this.getAttribute('data-id'));
                        const titulo = this.getAttribute('data-titulo');
                        const descripcion = this.getAttribute('data-descripcion');
                        
                        if (escenaId !== currentSceneId) {
                            document.querySelectorAll('.escena-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            
                            currentSceneId = escenaId;
                            initViewer(imagenUrl);
                            actualizarDescripcion(titulo, descripcion);
                        }
                    }
                });
                
                escenasMenu.appendChild(btn);
            });
            
            escenasMenu.classList.add('active');
        }
        
        categoriaBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const categoriaId = parseInt(this.getAttribute('data-categoria-id'));
                const fondoUrl = this.getAttribute('data-fondo');
                const categoriaTitulo = this.getAttribute('data-titulo');
                
                if (categoriaId !== currentCategoriaId) {
                    categoriaBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentCategoriaId = categoriaId;
                    
                    if (fondoUrl) {
                        initViewer(fondoUrl);
                        actualizarDescripcion(categoriaTitulo, '');
                    } else {
                        const escenas = escenasData[categoriaId] || [];
                        if (escenas.length > 0) {
                            initViewer(escenas[0].imagen);
                            actualizarDescripcion(escenas[0].titulo, escenas[0].descripcion);
                        }
                    }
                    
                    mostrarEscenas(categoriaId);
                    currentSceneId = null;
                    document.querySelectorAll('.escena-btn').forEach(b => b.classList.remove('active'));
                } else {
                    if (escenasMenu.classList.contains('active')) {
                        escenasMenu.classList.remove('active');
                    } else {
                        mostrarEscenas(categoriaId);
                    }
                }
            });
        });
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-container')) {
                escenasMenu.classList.remove('active');
            }
        });
        
        mostrarEscenas(currentCategoriaId);
    </script>
    {% else %}
    <div class="no-escenas">
        <h1>Visor 360</h1>
        <p>No hay categorías ni escenas 360 disponibles.</p>
        <p>Por favor, agrega categorías y escenas desde el panel de administración.</p>
        <a href="/admin/cms/categoriaescena/">Ir al Panel de Administración</a>
    </div>
    {% endif %}
</body>
</html>